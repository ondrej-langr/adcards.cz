{% extends '@app/layouts/site-layout/site-layout.twig' %}

{% block head %}
    <link rel="stylesheet" href="/css/pages/order-underpage.css">
{% endblock %}

{% block content %}
    {% set shippingKeyAndMetadata = order.getShippingMethod()|split("; ") %}
    {% set shippingMetadata = shippingMethods[shippingKeyAndMetadata[0]] %}
    <div class='order-underpage' id='order-underpage'>
        <div class='text-center thank-you-page-title'>
            <h3 class='text-muted'>
                {% if order.getStatus().value|lower == "nezaplaceno" %}
                    {{ "Děkujeme! Stačí už jen zaplatit!"|t }} 💸
                {% elseif order.getStatus().value|lower != "dokončeno" %}
                    {{ "Děkujeme! Vyčkejte na odeslání objednávky"|t }}🥁
                {% else %}
                    {{ "Děkujeme! Objednávka dokončena"|t }} 🎉
                {% endif %}
            </h3>
            <h1>{{ "Přehled objednávky"|t }}: <span class='text-brands-signature'>#{{ order.getId() }}</span></h1>
        </div>
        {% set orderPageProps = {
            order: {
                status: order.getStatus().value,
                currency: 'CZK'
            },
            initialPaymentDialogShown: showPaymentDialog ? true : false,
            thankYouMessageShown: showThankYou ? true : false,
            payPal: {
                clientId: payPal.clientId,
                routes: {
                    create: url_for('paypal-create-order', { orderUuid: order.get_uuid() }),
                    capture: url_for('paypal-capture-order', { orderUuid: order.get_uuid() })
                }
            }
        } %}
        <script>
        </script>
        <div class='order-underpage__content'
             x-data='orderPage(JSON.parse(`{{ orderPageProps|json_encode|replace({'\\n': '\\\n'}) }}`))'>
            <div>
                <section>
                    <h2>{{ "Informace o objednávce"|t }}</h2>
                    <ul>
                        <li>{{ "Číslo objednávky"|t }}: #{{ order.getId() }}</li>
                        <li>{{ "Datum objednání"|t }}: {{ order.getCreatedAt()|date("j.n. Y @ h:i") }}</li>
                        <li>{{ "Aktuální stav"|t }}: {{ order.getStatus().value|t }}</li>
                        {% if order.getPromoCodeAmount() %}
                            <li>
                                {{ "Slevový kód"|t }}: {{ order.getPromoCodeValue() }}
                                (-{{ order.getPromoCodeAmount() }}%)
                            </li>
                        {% endif %}
                    </ul>
                </section>
                <section>
                    <h2>{{ "Adresa"|t }}</h2>
                    <ul>
                        <li class='mb-2'>{{ order.getFirstName() }} {{ order.getLastName() }}</li>
                        <li>{{ order.getStreet() }} {{ order.getBuildingNumber() }}</li>
                        <li>{{ order.getCity() }}, {{ order.getPostalCode() }}</li>
                    </ul>
                </section>
                <section>
                    <h2>{{ "Doprava"|t }}</h2>
                    <ul>
                        <li>{{ "Typ dopravy"|t }}: {{ shippingMetadata.title|t }}</li>
                        {% if shippingKeyAndMetadata[1] %}
                            <li>{{ "Doplňující informace"|t }}: {{ shippingKeyAndMetadata[1] }}</li>
                        {% endif %}
                        {% if order.getShippingRate() %}
                            <li>{{ "Cena za dopravu"|t }}: {{ order.getShippingRate() }} Kč</li>
                        {% endif %}
                    </ul>
                </section>
                <section>
                    <h2>{{ "Platební informace"|t }}</h2>
                    <ul>
                        <li class='mb-2'>
                            {{ "Typ platby"|t }}: {{ paymentMethods[order.getPaymentMethod()].title|t }}
                        </li>
                        <li>
                            {{ "Zaplaceno"|t }}:
                            {{ (order.getStatus().value|lower == "nezaplaceno" ? "ne" : "ano")|t|upper }}
                        </li>
                        {% if order.getStatus().value|lower == "nezaplaceno" %}
                            <li>
                                <div class="alternate-alert warning mb-2 mt-3" role="alert">
                                    {{ "Zaplaťte objednávku do sedmi dní. Pokud tak neučiníte bude objednávka automaticky stornována!"|t }}
                                </div>

                                {% if order.getPaymentMethod() == "paypal" %}
                                    <button @click='modalOpen = !modalOpen'>
                                        {{ "Zaplatit kartou nebo pomocí PayPal učtu"|t }}
                                    </button>
                                {% endif %}
                            </li>
                        {% endif %}
                    </ul>
                </section>
                {% if order.getNote() %}
                    <section>
                        <h2>{{ "Poznámka"|t }}</h2>
                        <p>
                            {{ order.getNote() }}
                        </p>
                    </section>
                {% endif %}
            </div>
            <div>
                {% if order.getCards()|length > 0 %}
                    <section>
                        <h2>{{ "Objednané karty"|t }}</h2>
                        {% for item in order.getCards() %}
                            {{ include("@app/components/small-card.twig", {
                                "card": item,
                                "index": loop.index0,
                                readOnly: true
                            }) }}
                        {% endfor %}
                    </section>
                {% endif %}
                {% if order.getProducts()|length > 0 %}
                    <section>
                        <h2>{{ "Objednané produkty"|t }}</h2>
                        {% for item in order.getProducts() %}
                            {{ include("@app/components/small-product.twig", {
                                orderedProduct: item,
                                readOnly: true
                            }) }}
                        {% endfor %}
                    </section>
                {% endif %}
                <section>
                    <div class='d-flex justify-content-between text-muted'>
                        <p>Mezisoučet: </p>
                        <p>
                            {% if order.getPromoCodeAmount() %}
                                <s>{{ order.getSubtotalWithoutPromoCode() }} Kč</s>
                            {% endif %}
                            {{ order.getSubtotal() }} Kč
                        </p>
                    </div>
                    {% if order.getShippingRate() %}
                        <div class='d-flex justify-content-between mb-3'>
                            <p>{{ "Cena za dopravu"|t }}:</p>
                            <p>{{ order.getShippingRate() }} Kč</p>
                        </div>
                    {% endif %}
                    <div class='d-flex justify-content-between'>
                        <p class='font-weight-bold'>{{ "Celková částka"|t }}:</p>
                        <p class='text-brands-signature font-weight-bold'>{{ order.getTotalCost() }} Kč</p>
                    </div>
                </section>
            </div>

            {% if order.getPaymentMethod() != "bank-transfer" %}
                {# Payment dialog #}
                <dialog class='payment-dialog' :style='{ display: modalOpen ? "flex" : "none" }'
                        {% if showPaymentDialog == false %}style='display: none'{% endif %}>
                    <div class='payment-dialog__content'>
                        <div class='payment-dialog__content-inner'>
                            <img class='payment-dialog__logo' src="/images/logo_AD.png" />
                            <h3 class='text-center mb-4'>{{ "Platba objednávky"|t }} <span
                                        class='text-brands-signature'>#{{ order.getId() }}</span>
                            </h3>
                            <div x-show='errors.payPal' x-text='errors.payPal' class='alternate-alert error'></div>
                            <div x-ref='payPalButtons' class='paypal-buttons'>
                                <div style='height: 45px' class='skeleton w-100'></div>
                                <div style='height: 45px; margin-top: 1rem' class='skeleton w-100'></div>
                            </div>
                        </div>
                        <a @click.prevent='modalOpen = !modalOpen' class='payment-dialog__close-link'
                           href='#'>{{ "Nebo zaplatit pozdějí"|t }}</a>
                    </div>
                </dialog>
            {% endif %}

            {% if showThankYou %}
                {{ include("@app/components/toast-alert.twig", { message: "Objednávka zaplacena. Děkujeme!"|t }) }}
            {% endif %}
        </div>
    </div>
    <script>
      window.document.querySelector('.thank-you-page-title').scrollIntoView({
        behavior: 'smooth',
        block: 'center',
        inline: 'center',
      })

      window.applyLazyLoad?.()
    </script>
{% endblock %}
