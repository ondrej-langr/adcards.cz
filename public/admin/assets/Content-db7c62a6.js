import{r as u,c as A,g as W,a as $,p as G,q as z,j as a,s as T,_ as Q,t as H,v as K,w as J,x as X,m as I,y as v,z as Y,E as _,G as Z,u as k,M as p,H as O,J as N,K as ee,L as y,Q as j,A as se,R as te,o as U,S as ae,V as w,W as F,i as b,X as C,Y as re,Z as E,$ as ne,a0 as oe,a1 as ie,a2 as ce,d as le}from"./index-d65991cf.js";var de=Object.defineProperty,P=Object.getOwnPropertySymbols,ue=Object.prototype.hasOwnProperty,pe=Object.prototype.propertyIsEnumerable,R=(t,e,s)=>e in t?de(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,M=(t,e)=>{for(var s in e||(e={}))ue.call(e,s)&&R(t,s,e[s]);if(P)for(var s of P(e))pe.call(e,s)&&R(t,s,e[s]);return t};function me(t){const[e,s]=u.useState(t),n=u.useCallback(o=>s(r=>M(M({},r),typeof o=="function"?o(r):o)),[]);return[e,n]}const B=u.createContext({view:"create",isLoading:!0,exitView:()=>{},mutateUser:async()=>{}}),h=()=>u.useContext(B),Fe=({view:t,children:e})=>{const s=A(),{userId:n}=W(),o=$("users"),r=G(n,{enabled:!1}),l=z(),d=()=>s(T.users.list),m=u.useCallback(i=>{l.setQueryData(r.key,c=>({...c,...i}))},[l,r.key]);return u.useEffect(()=>(n&&r.refetch(),()=>r.remove()),[n]),a.jsx(B.Provider,{value:{view:t,...r.data?{user:r.data}:{},mutateUser:m,isLoading:r.isLoading||r.isError,exitView:d,model:o},children:e})};function ge(t){var e=t==null?0:t.length;return e?t[e-1]:void 0}var xe=ge,fe=Q,we=H;function be(t,e){return e.length<2?t:fe(t,we(e,0,-1))}var he=be,Se=K,je=xe,ve=he,ke=J;function Ue(t,e){return e=Se(e,t),t=ve(t,e),t==null||delete t[ke(je(e))]}var Ne=Ue,_e=Ne;function ye(t,e){return t==null?!0:_e(t,e)}var Ce=ye;const Ee=X(Ce),Pe=()=>{const{model:t}=h(),e=I(),{formState:s}=v(),n=u.useMemo(()=>{if(!t)return;const o={...t,columns:new Map(t.columns)};return o.columns.has("role")&&!(e!=null&&e.can({action:"update",targetModel:"users"}))&&Ee(o,"columns.role"),Y(o,_.MAIN)},[t,e]);return a.jsxs(a.Fragment,{children:[n&&a.jsx(Z,{type:_.MAIN,fields:n}),s.isSubmitting&&a.jsx("div",{className:"absolute inset-0 cursor-progress bg-white/20 backdrop-blur-[2px]"})]})},Re=()=>{const{view:t}=h(),{t:e}=k();return a.jsx("header",{className:"mr-9 w-full border-b-2 border-project-border pb-5 xl:mr-0",children:a.jsx("h1",{className:"m-0 text-5xl font-bold",children:e(t=="update"?p.UPDATE_AN_USER:p.CREATE_AN_USER)})})},Me=({className:t,...e})=>a.jsx(F,{className:j("relative top-0.5 inline-block h-4",t),...e}),Ae=()=>{const{isLoading:t,view:e,user:s,exitView:n,mutateUser:o}=h(),{watch:r,formState:{isSubmitting:l}}=v(),d=I(),m=r(),{t:i}=k(),c=O(),[g,S]=me({isSendingPasswordReset:!1,isTogglingBlock:!1}),L=u.useMemo(()=>e==="update"?!!Object.keys(N(s||{},m)).length:!0,[m,e,s]),D=async()=>{confirm(i(p.ON_DELETE_REQUEST_PROMPT))&&(n(),b.users.delete(s==null?void 0:s.id))},V=async()=>{S({isSendingPasswordReset:!0});const x=(s==null?void 0:s.state)===w.passwordReset;try{await c({title:i("Password reset"),message:i(x?"Resending password reset email":"Sending user password reset email"),successMessage:i("User can now follow instruction in their email")},async()=>{const{data:f}=await b.users.requestPasswordReset(s.email);o(f.data)})}catch{}S({isSendingPasswordReset:!1})},q=async()=>{S({isTogglingBlock:!0});const x=s.state===w.blocked;try{await c({title:i(x?"Unblocking":"Blocking"),message:"",successMessage:i(x?"User is now unblocked":"User is now blocked")},async()=>{const{data:f}=await b.users[x?"unblock":"block"](s.id);o(f.data)})}catch{}S({isTogglingBlock:!1})};return a.jsxs(ee,{isOpen:!0,children:[a.jsxs(y,{className:"!pt-0",title:i(p.PUBLISH_INFO),children:[e==="update"&&a.jsx("div",{className:j("w-full bg-white py-5 px-4"),children:a.jsx("ul",{className:"flex list-disc flex-col gap-2 pl-5",children:a.jsxs("li",{children:[i(p.STATE),":"," ",t?a.jsx(Me,{className:"w-full max-w-[6rem]"}):a.jsx("span",{className:"font-semibold text-blue-600",children:s==null?void 0:s.state})]})})}),a.jsxs("div",{className:"flex items-center justify-between gap-5 border-t-2 border-project-border px-4 py-4",children:[e==="update"?a.jsx(se,{size:"lg",type:"button",loading:l,onClick:D,color:"red",variant:"light",className:j(l&&"!cursor-progress","text-sm text-red-500"),children:a.jsx(te,{className:"aspect-square w-5"})}):a.jsx("span",{}),a.jsx(U,{size:"lg",color:"green",type:"submit",disabled:l||!L,loading:l,className:j(l&&"!cursor-progress"),children:i(l?e==="create"?"Creating...":"Updating...":e==="create"?"Create":"Update")})]})]}),e==="update"&&(d==null?void 0:d.can({action:"update",targetModel:"users"}))&&a.jsx(y,{title:i("Actions"),children:a.jsxs(ae,{cols:1,className:"p-5",children:[a.jsx(U,{loading:g.isSendingPasswordReset,disabled:!s||(s==null?void 0:s.state)===w.blocked,onClick:V,children:i((s==null?void 0:s.state)===w.passwordReset?"Resend password reset":"Send password reset")}),a.jsx(U,{loading:g.isTogglingBlock,disabled:!s,color:"red",onClick:q,children:i((s==null?void 0:s.state)===w.blocked?"Unblock user":"Block user")})]})})]})},Te=()=>{const t=A(),e=O(),{view:s,user:n,mutateUser:o}=h(),{t:r}=k(),{setError:l}=v();return async m=>{var i;try{await e({title:s==="update"?"Updating":"Creating",message:r(s==="update"?"Updating user data, please wait":"Creating new user, please wait"),successMessage:r(s==="update"?"User data has been updated!":"New user has been created!"),errorMessage:c=>{var g;return C.isAxiosError(c)&&((g=c.response)==null?void 0:g.status)===409?r(p.DUPLICATE_USER):r(p.ERROR_BASIC)}},async()=>{if(s==="update"){const c=await b.users.update(n==null?void 0:n.id,N(n,m));o(c.data.data)}else if(s==="create"){const c=await b.users.create(N(n||{},m));c!=null&&c.data&&t(T.users.list)}})}catch(c){C.isAxiosError(c)&&((i=c.response)==null?void 0:i.status)===409&&l("email",{message:r(p.DUPLICATE_USER)})}}},Ie=({children:t})=>{const{handleSubmit:e}=v(),s=Te();return a.jsx("form",{onSubmit:e(s),autoComplete:"off",children:t})},Be=()=>{var d;const{user:t,model:e,isLoading:s,view:n}=h(),{t:o}=k(),r=re({defaultValues:t||{},reValidateMode:"onBlur",mode:"onTouched",resolver:n==="create"?E(ne):E(oe)}),{reset:l}=r;return u.useEffect(()=>{t&&l(t)},[t,l]),a.jsx(ie,{...r,children:a.jsxs(Ie,{children:[a.jsx(ce,{className:"py-5",items:[{content:o(le((e==null?void 0:e.tableName)||"")),isLinkTo:`/${(d=e==null?void 0:e.tableName)==null?void 0:d.toLowerCase()}`},{content:o(n=="update"?"Update":"Create")},...n==="update"?[{content:s?a.jsx(F,{className:"h-4 w-16"}):a.jsx("p",{className:"text-green-500 underline",children:n=="update"?t==null?void 0:t.id:"Send invite"})}]:[]]}),a.jsxs("div",{className:"mt-10 items-start justify-between xl:flex",children:[a.jsxs("div",{className:"relative -mx-3 grid w-full max-w-4xl gap-5 px-3",children:[a.jsx(Re,{}),a.jsx(Pe,{})]}),a.jsx(Ae,{})]})]})})};export{Fe as C,Be as a};
