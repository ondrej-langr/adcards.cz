import{r as u,i as y,l as L,m as k,j as t,x as M,a as V,U as W,y as H,u as R,D as C,f as N,M as d,e as w,E as U,w as j,k as I,n as P,B as b,G as f,A as G,T as Q,b as Y,s as A,H as T,c as z,o as E}from"./index-LnQetCf-.js";import{c as J,u as K,p as X,F as Z}from"./prepareFieldsForMapper-rjzHXStO.js";import{u as v}from"./useRequestWithNotifications-TWKFQLGx.js";import{A as $}from"./AsideItemWrap-GZxnXfso.js";import{A as ee}from"./AsideWrapper-oGcS6fHR.js";function se(o){const[a,s]=u.useState(o),c=u.useCallback(e=>s(n=>({...n,...typeof e=="function"?e(n):e})),[]);return[a,c]}const _=u.createContext({view:"create",exitView:()=>{}}),h=()=>u.useContext(_),ue=({view:o,children:a})=>{const s=y(),c=L(k.USERS),e=()=>s({to:M.users.list});return t.jsx(_.Provider,{value:u.useMemo(()=>({view:o,exitView:e,model:c}),[o,e,c]),children:a})},S=()=>{const{userId:o}=V({from:W.id});return H(o)},te=()=>{const o=y(),a=v(),{data:s,refetch:c}=S(),{view:e}=h(),{t:n}=R(),{setError:r}=C();return async l=>{var m;try{await a({title:e==="update"?"Updating":"Creating",message:n(e==="update"?"Updating user data, please wait":"Creating new user, please wait"),successMessage:n(e==="update"?"User data has been updated!":"New user has been created!"),errorMessage:i=>{var p;return N.isAxiosError(i)&&((p=i.response)==null?void 0:p.status)===409?n(d.DUPLICATE_USER):n(d.ERROR_BASIC)}},async()=>{if(e==="update")await w.users.update(s==null?void 0:s.id,U(s,l)),await c();else if(e==="create"){const i=await w.users.create(U(s||{},l));i!=null&&i.data&&o({to:M.users.list})}})}catch(i){N.isAxiosError(i)&&((m=i.response)==null?void 0:m.status)===409&&r("email",{message:n(d.DUPLICATE_USER)})}}},ae=()=>{const{view:o}=h(),{data:a}=S(),{t:s}=R();return t.jsx(ee,{isOpen:!0,children:t.jsx($,{className:"!pt-0",title:s(d.PUBLISH_INFO),children:o==="update"&&t.jsx("div",{className:j("w-full bg-white py-5 px-4"),children:t.jsx("ul",{className:"flex list-disc flex-col gap-2 pl-5",children:t.jsxs("li",{children:[s(d.STATE),":"," ",t.jsx("span",{className:"font-semibold text-blue-600",children:a==null?void 0:a.state})]})})})})})},oe=()=>{const{watch:o,formState:{isSubmitting:a}}=C(),{view:s,exitView:c}=h(),{data:e,refetch:n}=S(),{t:r}=R(),g=o(),{user:l}=I(),m=v(),[i,p]=se({isSendingPasswordReset:!1,isTogglingBlock:!1}),B=async()=>{confirm(r(d.ON_DELETE_REQUEST_PROMPT))&&(c(),w.users.delete(e==null?void 0:e.id))},F=u.useMemo(()=>s==="update"?!!Object.keys(U(e||{},g)).length:!0,[g,s,e]),O=async()=>{p({isSendingPasswordReset:!0});const x=(e==null?void 0:e.state)===f.passwordReset;try{await m({title:r("Password reset"),message:r(x?"Resending password reset email":"Sending user password reset email"),successMessage:r("User can now follow instruction in their email")},async()=>{await w.profile.requestPasswordReset(e.email)})}catch{}p({isSendingPasswordReset:!1})},D=async()=>{p({isTogglingBlock:!0});const x=e.state===f.blocked;try{await m({title:r(x?"Unblocking":"Blocking"),message:"",successMessage:r(x?"User is now unblocked":"User is now blocked")},async()=>{await w.users[x?"unblock":"block"](e.id),await n()})}catch{}p({isTogglingBlock:!1})};return t.jsxs("div",{className:"flex items-center justify-between pb-3",children:[t.jsx("header",{className:"mr-2 w-full",children:t.jsx("h1",{className:"m-0 text-3xl font-bold",children:r(s=="update"?d.UPDATE_AN_USER:d.CREATE_AN_USER)})}),t.jsxs("div",{className:"flex gap-5",children:[s==="update"&&l&&P({userRole:l.role,action:"update",targetEntityTableName:k.USERS})&&t.jsxs(t.Fragment,{children:[t.jsx(b,{loading:i.isSendingPasswordReset,disabled:!e||(e==null?void 0:e.state)===f.blocked,onClick:O,children:r((e==null?void 0:e.state)===f.passwordReset?"Resend password reset":"Send password reset")}),t.jsx(b,{loading:i.isTogglingBlock,disabled:!e,color:"red",onClick:D,children:r((e==null?void 0:e.state)===f.blocked?"Unblock user":"Block user")})]}),t.jsx(b,{color:"green",type:"submit",disabled:a||!F,loading:a,className:j(a&&"!cursor-progress"),children:r(a?s==="create"?"Creating...":"Updating...":s==="create"?"Create":"Update")}),s==="update"?t.jsx(G,{type:"button",loading:a,onClick:B,color:"red",variant:"light",className:j(a&&"!cursor-progress","text-sm text-red-500"),children:t.jsx(Q,{className:"aspect-square w-5"})}):null]})]})},re=({children:o})=>{const{handleSubmit:a}=C(),s=te();return t.jsx("form",{onSubmit:a(s),autoComplete:"off",children:o})},me=()=>{const{view:o}=h(),{model:a}=h(),{data:s}=S(),{user:c}=I(),e=Y({defaultValues:s||{},reValidateMode:"onBlur",mode:"onTouched",resolver:o==="create"?A(J):A(K)}),{reset:n,formState:r}=e,g=u.useMemo(()=>{if(!a)return;const l=a.columns.findIndex(m=>m.name==="role");return l>-1&&c&&!P({userRole:c.role,action:"update",targetEntityTableName:k.USERS})&&(a.columns=a.columns.splice(l,1)),X(a,T.MAIN)},[a,s]);return u.useEffect(()=>{s&&n(s)},[s,n]),t.jsx(z,{...e,children:t.jsx(re,{children:t.jsxs(E,{rightAsideOutlet:o==="update"?t.jsx(ae,{}):null,children:[t.jsx(E.Header,{children:t.jsx(oe,{})}),t.jsxs(E.Content,{children:[g?t.jsx(Z,{type:T.MAIN,fields:g}):null,r.isSubmitting?t.jsx("div",{className:"absolute inset-0 cursor-progress bg-white/20 backdrop-blur-[2px]"}):null]})]})})})};export{ue as C,me as a};
