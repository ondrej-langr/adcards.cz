import{aE as Q,r as a,aF as B,a as $,ay as J,e as O,a1 as H,s as X,aG as R,u as w,b as Y,E as V,f as Z,aH as K,j as t,c as ee,H as te,D as k,B as _,aI as S,a8 as se,M as F,A as ne,w as L,aJ as oe,T as ae,h as ie,o as re}from"./index-RZzWi_an.js";import{H as I,L as le,W as ce,C as ue,D as de}from"./LanguageMutation-E6naSb9D.js";import{g as me,a as ge,E as pe}from"./prepareFieldsForMapper-QcWYpovM.js";import"./ImageSelect-wqui42LO.js";import"./mustache-pw7NTnrt.js";import"./FileList-1E17pXjI.js";import"./LanguageSelect-P3IDe1cr.js";import{t as U}from"./toastedPromise-Ygx8j2qQ.js";import"./Divider-pvOMJq4Z.js";import"./Table-u_beJina.js";import"./ScrollArea-8OXu0X4u.js";import"./Textarea-zuGOQJYS.js";import"./extends-qk8NM5Da.js";import"./useRequestWithNotifications-JUVnYa28.js";import"./Select-1m3NTbtF.js";import"./Skeleton-87WkLQaN.js";import"./Repeater-IGNRWcTk.js";import"./ItemsMissingMessage-Kz9yIuR1.js";import"./useModelItems-iBgjFD__.js";import"./Drawer-tpPcI0qJ.js";import"./NativeScrollArea-xY8Tlx7e.js";import"./Overlay-yVmGNtgA.js";import"./get-auto-contrast-value-TBhcg1GA.js";import"./Modal-1DAK8hBG.js";const fe=s=>{const{singletons:n}=Q();return a.useMemo(()=>n&&n[s],[s,n])};console.log({SingletonUnderpageRoute:B});const f=(s=!1)=>{const{singletonId:n}=$({from:B.id}),e=a.useMemo(()=>String(n),[n]),o=fe(e);if(s&&!o)throw new Error("Model not found");return a.useMemo(()=>o?{...o,key:e}:void 0,[e,o])};function he({queryKey:s}){return O.singletons.for(s[0]).get(s[1]).then(({data:n})=>n.data)}function z(s,n){const e=f(!0);return J([e.key,s],he,n)}z.refetch=()=>{};const q=a.createContext({setLanguage:()=>{},isLoading:!0,async clear(){}}),G=()=>a.useContext(q),xe=({children:s})=>{var c,A;const n=H(),e=f(!0),o=a.useMemo(()=>{if(!e)return;const P=me(e,!0);return async(b,y,j)=>{const u=await X(P)(b,y,j);return R.warning("Validating form:"),R.warning({data:b,result:u}),u}},[e]),{t:r}=w(),[i,l]=a.useState((A=(c=n.application)==null?void 0:c.i18n)==null?void 0:A.default),{data:d,isLoading:C,refetch:m}=z({language:i},{refetchInterval:0,refetchOnMount:!0,refetchOnReconnect:!1,refetchOnWindowFocus:!1,refetchIntervalInBackground:!1}),g=Y({defaultValues:ge(e,d??{}),reValidateMode:"onChange",mode:"onTouched",resolver:o}),{handleSubmit:E,setError:M}=g;a.useEffect(()=>{d&&g.reset(d)},[d,g.reset]);const T=E(async P=>{var y,j;const b=e.key;try{await U({title:"Updating",message:r("Updating, please wait..."),successMessage:r("Your entry is updated!")},async()=>{const u=V(d,P);await O.singletons.for(b).update(u,{language:i}),await m()})}catch(u){if(Z.isAxiosError(u)&&K(u.response)&&((y=u.response.headers["content-description"])!=null&&y.includes(String(pe)))){const v=u.response.data.data;if(Array.isArray(v)&&v.length)for(const N of v){const p=(j=e==null?void 0:e.columns)==null?void 0:j.find(W=>W.name===N);if(!p)continue;let D=N;N==="slug"&&(p==null?void 0:p.type)==="slug"&&(D=p.of),M(D,{message:r("This field is unique and other entry has the same value")})}}}}),h=a.useCallback(async()=>U({message:r("Clearing singleton..."),title:r("Clearing"),errorMessage:r("Failed to clear"),successMessage:r("Clearing successful!")},async()=>{await O.singletons.for(e==null?void 0:e.key).clear(),await m()}),[e,r,g.reset]),x=a.useMemo(()=>({language:i,setLanguage:l,data:d,isLoading:C,clear:h}),[i,l,h]);return t.jsx(ee,{...g,children:t.jsx(q.Provider,{value:x,children:t.jsx("form",{onSubmit:T,children:s})})})},be=()=>{const{name:s,title:n,columns:e}=f(!0),{t:o}=w();return a.useMemo(()=>e&&!!e.find(i=>!i.hide&&i.admin.editor.placement===te.MAIN&&i.type==="string"&&i.admin.fieldType==="heading"),[e])?null:t.jsxs(I,{children:[t.jsxs(I.Title,{children:[o("Update")," ",n||s]}),t.jsx(I.Divider,{})]})},ye=()=>{const{formState:s,reset:n}=k(),{t:e}=w(),{clear:o}=G(),[r,i]=a.useState(!1),l=async()=>{confirm(e(F.ON_DELETE_REQUEST_PROMPT))&&(await o(),n())};return t.jsxs(S,{withArrow:!0,arrowPosition:"center",position:"bottom-end",onOpen:()=>i(!0),onClose:()=>i(!1),children:[t.jsx(S.Target,{children:t.jsx(se,{withArrow:!0,label:e(F.MORE_OPTIONS_BUTTON_TEXT),position:"bottom-end",arrowPosition:"center",color:"gray",disabled:r,children:t.jsx(ne,{size:"xl",color:"gray",variant:"light",type:"button",className:L(s.isSubmitting&&"!cursor-progress"),loading:s.isSubmitting,styles:{root:{width:50,height:50}},children:t.jsx(oe,{className:"aspect-square w-20 duration-150"})})})}),t.jsx(S.Dropdown,{children:t.jsx(S.Item,{type:"button",onClick:l,color:"red",className:L(s.isSubmitting&&"!cursor-progress"),leftSection:t.jsx(ae,{className:"aspect-square w-4"}),children:e(F.PURGE_DATA)})})]})},je=()=>{var x;const{watch:s}=k(),n=s(),{t:e}=w(),{data:o,setLanguage:r,language:i}=G(),l=f(),d=H(),{setValue:C,formState:m}=k(),g=a.useMemo(()=>!!Object.keys(V(o||{},n)).length,[n,o]),E=()=>{},M=a.useMemo(()=>{let c="";return m.isSubmitting?c="Updating":c="Update",e(c)},[m.isSubmitting,e]),T=a.useMemo(()=>{let c="";return!(l!=null&&l.draftable)||!o?c:(o.is_published?c="Unpublish":c="Publish",e(c))},[o,m.isSubmitting,l,e]),h=()=>{C("is_published",o?!o.is_published:!1)};return t.jsxs("nav",{className:"align-center sticky bottom-1 left-0 z-10 mx-auto flex max-h-20 items-center justify-end gap-2 px-5 rounded-prom bg-transparent",children:[(l==null?void 0:l.draftable)&&t.jsx(_,{size:"sm",variant:"transparent",type:"submit",disabled:m.isSubmitting,className:"ml-auto",onClick:h,px:"sm",children:T}),t.jsx(_,{size:"lg",color:"green",type:"submit",disabled:!g,loading:m.isSubmitting,onClick:E,children:M}),(((x=d.application)==null?void 0:x.i18n.languages.length)??0)>1?t.jsx(le,{language:i??"",onSelect:r}):null,t.jsx(ye,{})]})},Qe=ie("/_authorized/entities/singletons/$singletonId/")({component:we}),Se=()=>{const s=f(!0);return t.jsx(de,{modelInfo:s})};function we(){return t.jsx(xe,{children:t.jsxs(re,{rightAsideOutlet:!0,children:[t.jsx(je,{}),t.jsx(ce,{children:t.jsxs(ue,{children:[t.jsx(be,{}),t.jsx(Se,{})]})})]})})}export{Qe as Route};
