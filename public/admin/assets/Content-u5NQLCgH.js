import{r as u,c as I,f as Q,a as z,B as y,p as G,q as H,j as a,s as M,t as O,u as E,v as N,w as C,M as p,h as b,x as U,m as B,y as Y,z as v,E as J,G as K,H as R,J as j,A as X,K as Z,o as k,S as $,L as w,Q as F,R as ee,V as _,W as se,X as te,Y as ae,Z as re,_ as ne}from"./index-lKkbEZXj.js";var oe=Object.defineProperty,P=Object.getOwnPropertySymbols,ie=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable,T=(t,s,e)=>s in t?oe(t,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[s]=e,A=(t,s)=>{for(var e in s||(s={}))ie.call(s,e)&&T(t,e,s[e]);if(P)for(var e of P(s))ce.call(s,e)&&T(t,e,s[e]);return t};function le(t){const[s,e]=u.useState(t),n=u.useCallback(i=>e(r=>A(A({},r),typeof i=="function"?i(r):i)),[]);return[s,n]}const L=u.createContext({view:"create",isLoading:!0,exitView:()=>{},mutateUser:async()=>{}}),S=()=>u.useContext(L),we=({view:t,children:s})=>{const e=I(),{userId:n}=Q(),i=z(y.USERS),r=G(n,{enabled:!1}),l=H(),d=()=>e(M.users.list),m=u.useCallback(o=>{l.setQueryData(r.key,c=>({...c,...o}))},[l,r.key]);return u.useEffect(()=>(n&&r.refetch(),()=>r.remove()),[n]),a.jsx(L.Provider,{value:{view:t,...r.data?{user:r.data}:{},mutateUser:m,isLoading:r.isLoading||r.isError,exitView:d,model:i},children:s})},de=()=>{const t=I(),s=O(),{view:e,user:n,mutateUser:i}=S(),{t:r}=E(),{setError:l}=N();return async m=>{var o;try{await s({title:e==="update"?"Updating":"Creating",message:r(e==="update"?"Updating user data, please wait":"Creating new user, please wait"),successMessage:r(e==="update"?"User data has been updated!":"New user has been created!"),errorMessage:c=>{var g;return C.isAxiosError(c)&&((g=c.response)==null?void 0:g.status)===409?r(p.DUPLICATE_USER):r(p.ERROR_BASIC)}},async()=>{if(e==="update"){const c=await b.users.update(n==null?void 0:n.id,U(n,m));i(c.data.data)}else if(e==="create"){const c=await b.users.create(U(n||{},m));c!=null&&c.data&&t(M.users.list)}})}catch(c){C.isAxiosError(c)&&((o=c.response)==null?void 0:o.status)===409&&l("email",{message:r(p.DUPLICATE_USER)})}}},ue=()=>{const{model:t}=S(),s=B(),{formState:e}=N(),n=u.useMemo(()=>{if(!t)return;const i=t.columns.findIndex(r=>r.name==="role");return i>-1&&!(s!=null&&s.can({action:"update",targetEntityTableName:y.USERS}))&&(t.columns=t.columns.splice(i,1)),Y(t,v.MAIN)},[t,s]);return a.jsxs(a.Fragment,{children:[n?a.jsx(J,{type:v.MAIN,fields:n}):null,e.isSubmitting?a.jsx("div",{className:"absolute inset-0 cursor-progress bg-white/20 backdrop-blur-[2px]"}):null]})},pe=({className:t,...s})=>a.jsx(F,{className:j("relative top-0.5 inline-block h-4",t),...s}),me=()=>{const{isLoading:t,view:s,user:e,exitView:n,mutateUser:i}=S(),{watch:r,formState:{isSubmitting:l}}=N(),d=B(),m=r(),{t:o}=E(),c=O(),[g,h]=le({isSendingPasswordReset:!1,isTogglingBlock:!1}),D=u.useMemo(()=>s==="update"?!!Object.keys(U(e||{},m)).length:!0,[m,s,e]),V=async()=>{confirm(o(p.ON_DELETE_REQUEST_PROMPT))&&(n(),b.users.delete(e==null?void 0:e.id))},q=async()=>{h({isSendingPasswordReset:!0});const x=(e==null?void 0:e.state)===w.passwordReset;try{await c({title:o("Password reset"),message:o(x?"Resending password reset email":"Sending user password reset email"),successMessage:o("User can now follow instruction in their email")},async()=>{const{data:f}=await b.profile.requestPasswordReset(e.email);i(f.data)})}catch{}h({isSendingPasswordReset:!1})},W=async()=>{h({isTogglingBlock:!0});const x=e.state===w.blocked;try{await c({title:o(x?"Unblocking":"Blocking"),message:"",successMessage:o(x?"User is now unblocked":"User is now blocked")},async()=>{const{data:f}=await b.users[x?"unblock":"block"](e.id);i(f.data)})}catch{}h({isTogglingBlock:!1})};return a.jsxs(K,{isOpen:!0,children:[a.jsxs(R,{className:"!pt-0",title:o(p.PUBLISH_INFO),children:[s==="update"&&a.jsx("div",{className:j("w-full bg-white py-5 px-4"),children:a.jsx("ul",{className:"flex list-disc flex-col gap-2 pl-5",children:a.jsxs("li",{children:[o(p.STATE),":"," ",t?a.jsx(pe,{className:"w-full max-w-[6rem]"}):a.jsx("span",{className:"font-semibold text-blue-600",children:e==null?void 0:e.state})]})})}),a.jsxs("div",{className:"flex items-center justify-between gap-5 border-t-2 border-project-border px-4 py-4",children:[s==="update"?a.jsx(X,{size:"lg",type:"button",loading:l,onClick:V,color:"red",variant:"light",className:j(l&&"!cursor-progress","text-sm text-red-500"),children:a.jsx(Z,{className:"aspect-square w-5"})}):a.jsx("span",{}),a.jsx(k,{size:"lg",color:"green",type:"submit",disabled:l||!D,loading:l,className:j(l&&"!cursor-progress"),children:o(l?s==="create"?"Creating...":"Updating...":s==="create"?"Create":"Update")})]})]}),s==="update"&&(d==null?void 0:d.can({action:"update",targetEntityTableName:y.USERS}))&&a.jsx(R,{title:o("Actions"),children:a.jsxs($,{cols:1,className:"p-5",children:[a.jsx(k,{loading:g.isSendingPasswordReset,disabled:!e||(e==null?void 0:e.state)===w.blocked,onClick:q,children:o((e==null?void 0:e.state)===w.passwordReset?"Resend password reset":"Send password reset")}),a.jsx(k,{loading:g.isTogglingBlock,disabled:!e,color:"red",onClick:W,children:o((e==null?void 0:e.state)===w.blocked?"Unblock user":"Block user")})]})})]})},ge=()=>{const{view:t}=S(),{t:s}=E();return a.jsx("header",{className:"mr-9 w-full border-b-2 border-project-border pb-5 xl:mr-0",children:a.jsx("h1",{className:"m-0 text-5xl font-bold",children:s(t=="update"?p.UPDATE_AN_USER:p.CREATE_AN_USER)})})},xe=({children:t})=>{const{handleSubmit:s}=N(),e=de();return a.jsx("form",{onSubmit:s(e),autoComplete:"off",children:t})},be=()=>{var d;const{user:t,model:s,isLoading:e,view:n}=S(),{t:i}=E(),r=ee({defaultValues:t||{},reValidateMode:"onBlur",mode:"onTouched",resolver:n==="create"?_(se):_(te)}),{reset:l}=r;return u.useEffect(()=>{t&&l(t)},[t,l]),a.jsx(ae,{...r,children:a.jsxs(xe,{children:[a.jsx(re,{className:"py-5",items:[{content:i(ne((s==null?void 0:s.tableName)||"")),isLinkTo:`/${(d=s==null?void 0:s.tableName)==null?void 0:d.toLowerCase()}`},{content:i(n=="update"?"Update":"Create")},...n==="update"?[{content:e?a.jsx(F,{className:"h-4 w-16"}):a.jsx("p",{className:"text-green-500 underline",children:n=="update"?t==null?void 0:t.id:"Send invite"})}]:[]]}),a.jsxs("div",{className:"mt-10 items-start justify-between xl:flex",children:[a.jsxs("div",{className:"relative -mx-3 grid w-full max-w-4xl gap-5 px-3",children:[a.jsx(ge,{}),a.jsx(ue,{})]}),a.jsx(me,{})]})]})})};export{we as C,be as a};
