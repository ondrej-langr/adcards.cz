import{aJ as Q,r as i,aK as B,a as $,_ as J,e as D,a8 as V,s as X,aL as L,u as C,b as Y,E as H,f as K,aM as Z,j as t,c as ee,H as te,D as I,B as R,aN as w,af as se,M as k,A as ne,w as U,aO as oe,T as ae,h as ie,o as re}from"./index-yOKIGyhs.js";import{H as A,L as le,W as ce,C as ue,D as me}from"./LanguageMutation-SmwVOs74.js";import{g as de,a as ge,E as pe}from"./prepareFieldsForMapper-n-XwGTf5.js";import"./ImageSelect-uTX8WRsl.js";import"./useModelItems-swOYtnuG.js";import"./FileList-e-NMcu-p.js";import"./LanguageSelect-6tvgF7cz.js";import{t as _}from"./toastedPromise-imVxo4Y3.js";import"./Divider-dZ2Ci_Vh.js";import"./Table-4rjFBSvi.js";import"./Select-Tmriee6U.js";import"./Skeleton-ai2isshM.js";import"./Textarea-ClV9ngk2.js";import"./extends-dGVwEr9R.js";import"./use-disclosure-kjKicoPJ.js";import"./useRequestWithNotifications-FyVDP3uy.js";import"./Repeater-vXDQHgA9.js";import"./ItemsMissingMessage-BErgMmqr.js";import"./Drawer-N9Gfdqty.js";import"./NativeScrollArea-RnWAygQU.js";import"./Overlay-cDVy-Pzy.js";import"./Modal-8cyUESLD.js";const fe=s=>{const{singletons:n}=Q();return i.useMemo(()=>n&&n[s],[s,n])};console.log({SingletonUnderpageRoute:B});const x=(s=!1)=>{const{singletonId:n}=$({from:B.id}),e=i.useMemo(()=>String(n),[n]),o=fe(e);if(s&&!o)throw new Error("Model not found");return i.useMemo(()=>o?{...o,key:e}:void 0,[e,o])};function he({queryKey:s}){return D.singletons.for(s[0]).get(s[1]).then(({data:n})=>n.data)}function z(s,n){const e=x(!0);return J([e.key,s],he,n)}z.refetch=()=>{};const q=i.createContext({setLanguage:()=>{},isLoading:!0,async clear(){}}),W=()=>i.useContext(q),xe=({children:s})=>{var f,l;const n=V(),e=x(!0),o=i.useMemo(()=>{if(!e)return;const v=de(e,!0);return async(j,y,S)=>{const u=await X(v)(j,y,S);return L.warning("Validating form:"),L.warning({data:j,result:u}),u}},[e]),{t:c}=C(),[r,a]=i.useState((l=(f=n.application)==null?void 0:f.i18n)==null?void 0:l.default),{data:m,isLoading:M,refetch:d}=z({language:r},{refetchInterval:0,refetchOnMount:!0,refetchOnReconnect:!1,refetchOnWindowFocus:!1,refetchIntervalInBackground:!1}),g=Y({defaultValues:ge(e,m??{}),reValidateMode:"onChange",mode:"onTouched",resolver:o}),{handleSubmit:E,setError:T}=g;i.useEffect(()=>{m&&g.reset(m)},[m,g.reset]);const P=E(async v=>{var y,S;const j=e.key;try{await _({title:"Updating",message:c("Updating, please wait..."),successMessage:c("Your entry is updated!")},async()=>{const u=H(m,v);await D.singletons.for(j).update(u,{language:r}),await d()})}catch(u){if(K.isAxiosError(u)&&Z(u.response)&&((y=u.response.headers["content-description"])!=null&&y.includes(String(pe)))){const N=u.response.data.data;if(Array.isArray(N)&&N.length)for(const O of N){const h=(S=e==null?void 0:e.columns)==null?void 0:S.find(G=>G.name===O);if(!h)continue;let F=O;O==="slug"&&(h==null?void 0:h.type)==="slug"&&(F=h.of),T(F,{message:c("This field is unique and other entry has the same value")})}}}}),b=i.useCallback(async()=>_({message:c("Clearing singleton..."),title:c("Clearing"),errorMessage:c("Failed to clear"),successMessage:c("Clearing successful!")},async()=>{await D.singletons.for(e==null?void 0:e.key).clear(),await d()}),[e,c,g.reset]),p=i.useMemo(()=>({language:r,setLanguage:a,data:m,isLoading:M,clear:b}),[r,a,b]);return t.jsx(ee,{...g,children:t.jsx(q.Provider,{value:p,children:t.jsx("form",{onSubmit:P,children:s})})})},be=()=>{const{name:s,title:n,columns:e}=x(!0),{t:o}=C();return i.useMemo(()=>e&&!!e.find(r=>!r.hide&&r.admin.editor.placement===te.MAIN&&r.type==="string"&&r.admin.fieldType==="heading"),[e])?null:t.jsxs(A,{children:[t.jsxs(A.Title,{children:[o("Update")," ",n||s]}),t.jsx(A.Divider,{})]})},je=()=>{const{formState:s,reset:n}=I(),{t:e}=C(),{clear:o}=W(),[c,r]=i.useState(!1),a=async()=>{confirm(e(k.ON_DELETE_REQUEST_PROMPT))&&(await o(),n())};return t.jsxs(w,{withArrow:!0,arrowPosition:"center",position:"bottom-end",onOpen:()=>r(!0),onClose:()=>r(!1),children:[t.jsx(w.Target,{children:t.jsx(se,{withArrow:!0,label:e(k.MORE_OPTIONS_BUTTON_TEXT),position:"bottom-end",arrowPosition:"center",color:"gray",disabled:c,children:t.jsx(ne,{size:"xl",color:"gray",variant:"light",type:"button",className:U(s.isSubmitting&&"!cursor-progress"),loading:s.isSubmitting,styles:{root:{width:50,height:50}},children:t.jsx(oe,{className:"aspect-square w-20 duration-150"})})})}),t.jsx(w.Dropdown,{children:t.jsx(w.Item,{type:"button",onClick:a,color:"red",className:U(s.isSubmitting&&"!cursor-progress"),leftSection:t.jsx(ae,{className:"aspect-square w-4"}),children:e(k.PURGE_DATA)})})]})},ye=()=>{var f;const{watch:s}=I(),n=s(),{t:e}=C(),{data:o,setLanguage:c,language:r}=W(),a=x(),m=V(),{setValue:M,formState:d}=I(),g=i.useMemo(()=>!!Object.keys(H(o||{},n)).length,[n,o]),E=()=>{},T=i.useMemo(()=>{let l="";return d.isSubmitting?l="Updating":l="Update",e(l)},[d.isSubmitting,e]),P=i.useMemo(()=>{let l="";return!(a!=null&&a.draftable)||!o?l:(o.published?l="Unpublish":l="Publish",e(l))},[o,d.isSubmitting,a,e]),b=()=>{M("published",o?!o.published:!1)},p=i.useMemo(()=>a==null?void 0:a.columns.filter(l=>l.localized),[a]);return t.jsxs("nav",{className:"align-center sticky bottom-1 left-0 z-10 mx-auto flex max-h-20 items-center justify-end gap-2 px-5 rounded-prom bg-transparent",children:[(a==null?void 0:a.draftable)&&t.jsx(R,{size:"sm",variant:"transparent",type:"submit",disabled:d.isSubmitting,className:"ml-auto",onClick:b,px:"sm",children:P}),t.jsx(R,{size:"lg",color:"green",type:"submit",disabled:!g,loading:d.isSubmitting,onClick:E,children:T}),(((f=m.application)==null?void 0:f.i18n.languages.length)??0)>1&&(p!=null&&p.length)?t.jsx(le,{language:r??"",onSelect:c}):null,t.jsx(je,{})]})},We=ie("/_authorized/entities/singletons/$singletonId/")({component:we}),Se=()=>{const s=x(!0);return t.jsx(me,{modelInfo:s})};function we(){return t.jsx(xe,{children:t.jsxs(re,{rightAsideOutlet:!0,children:[t.jsx(ye,{}),t.jsx(ce,{children:t.jsxs(ue,{children:[t.jsx(be,{}),t.jsx(Se,{})]})})]})})}export{We as Route};
